---
import type { Project } from '@/lib/sanity';
import { Tile, TileContent, TileTitle, TileDescription } from '@/components/ui/tile';
import { Badge } from '@/components/ui/badge';
import { stegaClean } from '@sanity/client/stega';
import { urlFor } from '@/lib/image';

function sponsorLogoUrl(logo: NonNullable<Project['sponsor']>['logo']) {
  return logo ? urlFor(logo as unknown as Parameters<typeof urlFor>[0]).width(48).height(48).url() : null;
}

function portableTextExcerpt(content: Project['content'], maxLength = 150): string {
  if (!content) return '';
  const text = content
    .filter((block) => 'children' in block && block.children)
    .map((block) => ('children' in block ? block.children : [])?.map((child) => ('text' in child ? child.text : '')).join('') ?? '')
    .join(' ');
  return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
}

const statusStyles: Record<string, string> = {
  active: 'bg-green-100 text-green-800 border-green-300',
  completed: 'bg-blue-100 text-blue-800 border-blue-300',
  archived: 'bg-muted text-muted-foreground border-border',
};

interface Props {
  project: Project;
}

const { project } = Astro.props;
const slug = stegaClean(project.slug);
const status = stegaClean(project.status) || 'active';
const sponsor = project.sponsor;
const sponsorSlug = sponsor ? stegaClean(sponsor.slug) : null;
const logoUrl = sponsor?.logo ? sponsorLogoUrl(sponsor.logo) : null;
const excerpt = portableTextExcerpt(project.content);
const techs = project.technologyTags ?? [];
const industry = sponsor?.industry ? stegaClean(sponsor.industry) : '';
---

<div
  data-project-card
  data-tech-tags={techs.map(t => stegaClean(t)).join(',')}
  data-industry={industry}
>
  <Tile variant="floating" class="border-2 border-border hover:-translate-y-1 hover:shadow-[8px_8px_0_0_rgba(0,0,0,1)] transition-all duration-150 h-full">
    <TileContent class="flex flex-col h-full">
      <div class="flex items-start justify-between gap-3 mb-3">
        <a href={`/projects/${slug}`} class="no-underline text-inherit flex-1">
          <TileTitle class="text-xl">{project.title}</TileTitle>
        </a>
        {status && (
          <Badge class={statusStyles[status] || statusStyles.active}>{status}</Badge>
        )}
      </div>

      {sponsor && (
        <div class="flex items-center gap-2 mb-3">
          {logoUrl ? (
            <div class="w-8 h-8 bg-muted flex items-center justify-center flex-shrink-0 border border-border overflow-hidden">
              <img src={logoUrl} alt={sponsor.logo?.alt || `${sponsor.name} logo`} class="w-full h-full object-cover" loading="lazy" />
            </div>
          ) : (
            <div class="w-8 h-8 bg-muted flex items-center justify-center flex-shrink-0 border border-border">
              <span class="text-xs font-bold text-muted-foreground">
                {(sponsor.name || '').split(' ').map((w: string) => w[0]).join('').slice(0, 2)}
              </span>
            </div>
          )}
          <a
            href={`/sponsors/${sponsorSlug}`}
            class="text-sm text-primary hover:text-primary/80 font-medium no-underline"
          >
            {sponsor.name}
          </a>
        </div>
      )}

      {excerpt && (
        <TileDescription class="flex-1">{excerpt}</TileDescription>
      )}

      {project.semester && (
        <p class="text-xs text-muted-foreground mt-2">{project.semester}</p>
      )}

      {techs.length > 0 && (
        <div class="flex flex-wrap gap-1.5 mt-3">
          {techs.map((tag) => (
            <Badge variant="outline" class="text-xs">{tag}</Badge>
          ))}
        </div>
      )}
    </TileContent>
  </Tile>
</div>
