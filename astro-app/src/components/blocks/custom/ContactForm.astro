---
import type { ContactFormBlock } from '@/lib/types';
import { stegaClean } from '@sanity/client/stega';
import { Section, SectionSplit, SectionContent } from '@/components/ui/section';
import { AutoForm } from '@/components/ui/auto-form';
import { Icon } from '@/components/ui/icon';

interface Props extends ContactFormBlock {
  class?: string;
  id?: string;
}

const { heading, description, successMessage, form } = Astro.props;

const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
const formId = form?._id ?? '';

// Map Sanity formField[] → AutoForm Field[] with stegaClean on logic-critical values
const mappedFields = form?.fields?.map((field) => {
  const fieldType = stegaClean(field.type) ?? 'text';
  const fieldName = stegaClean(field.name) ?? '';
  const placeholder = stegaClean(field.options?.placeholder) ?? '';

  const base = {
    label: field.label ?? '',
    name: fieldName,
    required: field.required ?? false,
    placeholder,
  };

  // Map select/radio choices to string arrays for AutoForm
  if (fieldType === 'select') {
    return {
      ...base,
      type: 'select' as const,
      options: field.choices?.map((c) => stegaClean(c.value) || stegaClean(c.label) || '') ?? [],
    };
  }

  if (fieldType === 'radio') {
    return {
      ...base,
      type: 'radio-group' as const,
      options: field.choices?.map((c) => stegaClean(c.value) || stegaClean(c.label) || '') ?? [],
    };
  }

  if (fieldType === 'checkbox') {
    return { ...base, type: 'checkbox' as const };
  }

  if (fieldType === 'textarea') {
    return { ...base, type: 'textarea' as const, rows: 5 };
  }

  // text, email, tel, number, url, etc. → map to AutoForm input types
  const inputType = (['text', 'email', 'tel', 'number'] as const).includes(fieldType as 'text' | 'email' | 'tel' | 'number')
    ? (fieldType as 'text' | 'email' | 'tel' | 'number')
    : 'text';

  return { ...base, type: inputType };
}) ?? [];

const submitText = stegaClean(form?.submitButton?.text) || 'Submit Inquiry';
---

<Section data-animate>
  <SectionSplit>
    <SectionContent class="justify-center">
      {heading && (
        <h2 class="text-3xl md:text-4xl font-bold tracking-[-0.03em] leading-[1.1]">{heading}</h2>
      )}
      {description && (
        <p class="text-muted-foreground leading-relaxed">{description}</p>
      )}
    </SectionContent>

    <div data-contact-form data-gtm-form="contact" class="border-2 border-foreground p-8 md:p-12">
      <div data-form-fields>
        <AutoForm fields={mappedFields} submit={submitText}>
          <input type="hidden" name="form_id" value={formId} />
          <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="light"></div>
        </AutoForm>
      </div>

      <div
        data-form-success
        class="text-center py-12"
      >
        <div class="w-16 h-16 bg-primary flex items-center justify-center mx-auto mb-6">
          <Icon name="lucide:check" class="w-8 h-8 text-primary-foreground" />
        </div>
        <h3 class="text-2xl font-bold mb-3">Inquiry Received</h3>
        <p class="text-muted-foreground">{successMessage || 'Thank you for your inquiry. We will get back to you shortly.'}</p>
      </div>

      <div data-form-error role="alert" class="text-destructive text-sm font-medium mt-4">
        Something went wrong. Please try again.
      </div>
    </div>
  </SectionSplit>
</Section>

<style>
  [data-contact-form] [data-form-success] { display: none; }
  [data-contact-form][data-form-state="success"] [data-form-fields] { display: none; }
  [data-contact-form][data-form-state="success"] [data-form-success] { display: block; }
  [data-contact-form] [data-form-error] { display: none; }
  [data-contact-form] [data-form-error][data-visible] { display: block; }
</style>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" is:inline async defer></script>

<script>
  import { actions, isInputError } from 'astro:actions';

  document.querySelectorAll<HTMLElement>('[data-contact-form]').forEach((wrapper) => {
    const form = wrapper.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      const errorEl = wrapper.querySelector('[data-form-error]');

      // Client-side validation (quick feedback — Zod handles server-side)
      let valid = true;
      form.querySelectorAll<HTMLInputElement | HTMLTextAreaElement>('[required]').forEach((f) => {
        const errId = `${f.name}-error`;
        if (!f.value.trim()) {
          f.setAttribute('aria-invalid', 'true');
          f.setAttribute('aria-describedby', errId);
          valid = false;
        } else {
          f.removeAttribute('aria-invalid');
          f.removeAttribute('aria-describedby');
        }
      });
      const emailField = form.querySelector<HTMLInputElement>('[type="email"]');
      if (emailField?.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value)) {
        emailField.setAttribute('aria-invalid', 'true');
        valid = false;
      }
      if (!valid) {
        form.querySelector<HTMLElement>('[aria-invalid]')?.focus();
        return;
      }

      // Submit via Astro Action
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sending...';
      }
      errorEl?.removeAttribute('data-visible');

      const { error } = await actions.submitForm(new FormData(form));

      if (error) {
        if (isInputError(error)) {
          Object.entries(error.fields).forEach(([field, _messages]) => {
            const input = form.querySelector<HTMLElement>(`[name="${field}"]`);
            if (input) {
              input.setAttribute('aria-invalid', 'true');
              input.setAttribute('aria-describedby', `${field}-error`);
            }
          });
          form.querySelector<HTMLElement>('[aria-invalid]')?.focus();
        } else {
          errorEl?.setAttribute('data-visible', '');
        }
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Submit Inquiry';
        }
      } else {
        wrapper.dataset.formState = 'success';
        if (window.dataLayer) {
          window.dataLayer.push({ event: 'form_submit', form: { name: 'contact' } });
        }
      }
    });
  });
</script>
