---
import type { Testimonial } from '@/lib/sanity';
import { urlFor } from '@/lib/image';
import { stegaClean } from '@sanity/client/stega';

interface Props {
  testimonial: Testimonial;
}

const { testimonial: t } = Astro.props;
const photoUrl = t.photo
  ? urlFor(t.photo as unknown as Parameters<typeof urlFor>[0]).width(80).height(80).fit('crop').url()
  : null;
const projectSlug = t.project ? stegaClean(t.project.slug) : null;
---

<div class="flex flex-col gap-4 rounded-lg border border-border bg-card p-6">
  <blockquote class="text-base italic text-card-foreground leading-relaxed">"{t.quote}"</blockquote>
  <div class="flex items-center gap-3">
    {photoUrl ? (
      <img
        src={photoUrl}
        alt={t.photo?.alt ?? ''}
        width="48"
        height="48"
        loading="lazy"
        class="rounded-full object-cover w-12 h-12 flex-shrink-0"
      />
    ) : (
      <div class="w-12 h-12 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
        <span class="text-sm font-bold text-muted-foreground">
          {(t.name || '').split(' ').map((w: string) => w[0]).join('').slice(0, 2)}
        </span>
      </div>
    )}
    <div class="flex flex-col">
      <span class="font-semibold text-sm">{t.name}</span>
      {t.role && <span class="text-xs text-muted-foreground">{t.role}</span>}
      {t.organization && <span class="text-xs text-muted-foreground">{t.organization}</span>}
    </div>
  </div>
  {t.project && projectSlug && (
    <a href={`/projects/${projectSlug}`} class="text-xs font-medium text-primary hover:text-primary/80 inline-flex items-center gap-1">
      {t.project.title}
    </a>
  )}
</div>
