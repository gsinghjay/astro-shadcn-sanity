---
import type { HTMLAttributes } from "astro/types"
import { getIconData, iconToSVG, iconToHTML } from "@iconify/utils"
import lucideIcons from "@iconify-json/lucide/icons.json"
import simpleIcons from "@iconify-json/simple-icons/icons.json"

interface Props extends Omit<HTMLAttributes<"svg">, "name" | "href"> {
  href?: HTMLAttributes<"a">["href"]
  name?: string
}

const { name, href, class: className, ...rest } = Astro.props

const hrefMap: Record<string, string> = {
  "x.com": "simple-icons:x",
  twitter: "simple-icons:x",
  facebook: "simple-icons:facebook",
  instagram: "simple-icons:instagram",
  pinterest: "simple-icons:pinterest",
  youtube: "simple-icons:youtube",
  tiktok: "simple-icons:tiktok",
  snapchat: "simple-icons:snapchat",
  reddit: "simple-icons:reddit",
  tumblr: "simple-icons:tumblr",
  "wa.me": "simple-icons:whatsapp",
  telegram: "simple-icons:telegram",
  discord: "simple-icons:discord",
  vimeo: "simple-icons:vimeo",
  flickr: "simple-icons:flickr",
  yelp: "simple-icons:yelp",
  spotify: "simple-icons:spotify",
  behance: "simple-icons:behance",
  dribbble: "simple-icons:dribbble",
  soundcloud: "simple-icons:soundcloud",
  github: "simple-icons:github",
  twitch: "simple-icons:twitch",
  "tel:": "lucide:phone",
  "mailto:": "lucide:mail",
  "maps.app.goo.gl": "lucide:map-pin",
  linkedin: "simple-icons:linkedin",
}

const iconSets: Record<string, any> = {
  lucide: lucideIcons,
  "simple-icons": simpleIcons,
}

function resolveIconName(): string | undefined {
  if (name) {
    if (name.includes(":")) return name
    return `lucide:${name}`
  }
  if (href) {
    const hrefKey = Object.keys(hrefMap).find((key) => href.toString().includes(key))
    if (hrefKey) return hrefMap[hrefKey]
  }
  return undefined
}

function renderIcon(iconName: string): string | undefined {
  const [prefix, iconId] = iconName.split(":")
  const iconSet = iconSets[prefix]
  if (!iconSet) return undefined

  const data = getIconData(iconSet, iconId)
  if (!data) return undefined

  const svg = iconToSVG(data)

  // Build extra attributes string from rest props
  const classValue = ["size-[1em] text-base", className].filter(Boolean).join(" ")
  const extraAttrs: Record<string, string> = { class: classValue }
  for (const [key, value] of Object.entries(rest)) {
    if (value !== undefined && value !== null) {
      extraAttrs[key] = String(value)
    }
  }

  // Merge SVG attributes with extra props
  const allAttrs = { ...svg.attributes, ...extraAttrs }
  return iconToHTML(svg.body, allAttrs)
}

const resolvedName = resolveIconName()
const svgHtml = resolvedName ? renderIcon(resolvedName) : undefined
---

{svgHtml && <Fragment set:html={svgHtml} />}
