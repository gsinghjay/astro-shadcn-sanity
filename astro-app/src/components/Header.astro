---
import { getSiteSettings } from '../lib/sanity';
import { Header as HeaderUI, HeaderActions } from '@/components/ui/header';
import { Logo, LogoText } from '@/components/ui/logo';
import { Button } from '@/components/ui/button';
import { Sheet, SheetTrigger, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { Icon } from '@/components/ui/icon';
import { Separator } from '@/components/ui/separator';
import { stegaClean } from '@sanity/client/stega';
import { urlFor } from '@/lib/image';
import type { Image } from '@sanity/types';

const settings = await getSiteSettings();
const { navigationItems, ctaButton, siteName, logo } = settings;
const currentPath = Astro.url.pathname;

let logoUrl = '/logos/njit-logo-plain.svg';
if (logo?.asset) {
  try {
    logoUrl = urlFor(logo as unknown as Image).width(160).height(40).fit('max').url();
  } catch {
    logoUrl = logo.asset.url || logoUrl;
  }
}
const logoAlt = logo?.alt || 'NJIT';
const ctaText = ctaButton?.text || 'Become a Sponsor';
const ctaHref = ctaButton?.url || '/contact';

// Split siteName for header display (e.g., "YWCC Industry Capstone" â†’ "YWCC" + "Industry Capstone")
const nameParts = (siteName || 'YWCC Industry Capstone').split(' ');
const brandPrimary = nameParts[0];
const brandSecondary = nameParts.slice(1).join(' ');
---

<HeaderUI class="border-b-2 border-foreground">
  <Logo href="/">
    <img src={logoUrl} alt={logoAlt} class="h-8 w-auto" />
    <LogoText>
      <span class="flex flex-col">
        <span class="text-xs font-bold uppercase tracking-widest leading-tight">{brandPrimary}</span>
        <span class="text-2xs uppercase tracking-wider leading-tight text-muted-foreground">{brandSecondary}</span>
      </span>
    </LogoText>
  </Logo>

  <nav class="hidden md:flex items-center gap-8" aria-label="Main navigation">
    {(navigationItems || []).map((item) => (
      <a
        href={item.href}
        class:list={[
          'text-xs font-bold uppercase tracking-widest transition-colors duration-150',
          currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href || ''))
            ? 'text-primary'
            : 'text-foreground hover:text-primary',
        ]}
        data-gtm-category="navigation"
        data-gtm-label={stegaClean(item.label)}
      >
        {item.label}
      </a>
    ))}
  </nav>

  <HeaderActions>
    <Button href={ctaHref} class="hidden md:inline-flex" data-gtm-category="navigation" data-gtm-label="header-cta">{ctaText}</Button>
    <div class="md:hidden">
      <Sheet>
        <SheetTrigger variant="ghost" size="icon">
          <Icon name="menu" />
        </SheetTrigger>
        <SheetContent>
          <SheetHeader>
            <SheetTitle>Navigation</SheetTitle>
          </SheetHeader>
          <nav class="flex flex-col gap-2 p-4">
            {(navigationItems || []).map((item) => (
              <a
                href={item.href}
                class:list={[
                  'text-lg font-bold uppercase tracking-wider py-2',
                  currentPath === item.href ? 'text-primary' : 'text-foreground',
                ]}
                data-gtm-category="navigation"
                data-gtm-label={stegaClean(item.label)}
              >
                {item.label}
              </a>
            ))}
            <Separator class="my-2" />
            <Button href={ctaHref} class="w-full justify-center" data-gtm-category="navigation" data-gtm-label="header-cta">{ctaText}</Button>
          </nav>
        </SheetContent>
      </Sheet>
    </div>
  </HeaderActions>
</HeaderUI>
