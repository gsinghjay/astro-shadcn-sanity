---
/**
 * Spike 16.1 — Manual test page for Better Auth OAuth flow.
 * DELETE THIS FILE after spike is complete.
 */
export const prerender = false;

const sessionRes = await fetch(new URL('/api/auth/get-session', Astro.url.origin), {
  headers: Astro.request.headers,
});
const sessionData = sessionRes.ok ? await sessionRes.json() : null;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Spike 16.1 — Auth Test</title>
    <style>
      body { font-family: system-ui; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
      pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
      button { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; margin: 0.25rem; }
      .success { color: green; }
      .error { color: red; }
    </style>
  </head>
  <body>
    <h1>Spike 16.1 — Better Auth Test</h1>

    {sessionData?.session ? (
      <div>
        <p class="success">Authenticated!</p>
        <pre>{JSON.stringify(sessionData, null, 2)}</pre>
        <button id="signout">Sign Out</button>
      </div>
    ) : (
      <div>
        <p>Not authenticated.</p>
        <button id="signin">Sign in with Google</button>
      </div>
    )}

    <script>
      document.getElementById('signin')?.addEventListener('click', async () => {
        const res = await fetch('/api/auth/sign-in/social', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            provider: 'google',
            callbackURL: window.location.href,
          }),
        });
        const data = await res.json();
        if (data.url) window.location.href = data.url;
      });
      document.getElementById('signout')?.addEventListener('click', async () => {
        await fetch('/api/auth/sign-out', { method: 'POST' });
        window.location.reload();
      });
    </script>
  </body>
</html>
