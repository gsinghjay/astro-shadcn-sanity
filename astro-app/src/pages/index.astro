---
import Layout from '../layouts/Layout.astro';
import BlockRenderer from '../components/BlockRenderer.astro';
import SanityPageContent from '../components/SanityPageContent.astro';
import { getPage, getAllSponsors, getAllTestimonials, getAllEvents } from '../lib/sanity';
import { urlFor } from '../lib/image';
import type { Image } from '@sanity/types';

const visualEditingEnabled = import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED === 'true';

// In static mode: fetch page data and render inline
// In VE mode: skip fetch â€” server island handles its own data fetching
let page = null;
let sponsors: Awaited<ReturnType<typeof getAllSponsors>> = [];
let testimonials: Awaited<ReturnType<typeof getAllTestimonials>> = [];
let events: Awaited<ReturnType<typeof getAllEvents>> = [];
if (!visualEditingEnabled) {
  page = await getPage('home');
  if (!page) {
    return Astro.redirect('/404');
  }
  sponsors = await getAllSponsors();
  testimonials = await getAllTestimonials();
  events = await getAllEvents();
}

// Extract first hero image for <link rel="preload"> (LCP optimization)
const firstBlock = page?.blocks?.[0];
const heroImage = firstBlock?._type === 'heroBanner'
  ? (firstBlock as { backgroundImages?: Array<{ asset?: { _id: string } | null }> }).backgroundImages?.[0]
  : null;
const preloadImageUrl = heroImage?.asset
  ? urlFor(heroImage as unknown as Image).width(1920).height(1080).fit('crop').url()
  : undefined;
---

<Layout title={page?.title ?? undefined} seo={page?.seo} preloadImage={preloadImageUrl}>
  {visualEditingEnabled ? (
    <SanityPageContent server:defer slug="home">
      <div slot="fallback" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
        <div class="animate-pulse space-y-8">
          <div class="h-10 bg-muted rounded w-2/5"></div>
          <div class="h-64 bg-muted rounded"></div>
          <div class="space-y-3">
            <div class="h-4 bg-muted rounded w-3/4"></div>
            <div class="h-4 bg-muted rounded w-1/2"></div>
          </div>
        </div>
      </div>
    </SanityPageContent>
  ) : (
    <BlockRenderer blocks={page!.blocks ?? []} sponsors={sponsors} testimonials={testimonials} events={events} />
  )}
</Layout>
