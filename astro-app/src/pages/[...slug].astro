---
import type { GetStaticPaths } from 'astro';
import Layout from '@/layouts/Layout.astro';
import BlockRenderer from '@/components/BlockRenderer.astro';
import { sanityClient, ALL_PAGE_SLUGS_QUERY, getPage } from '@/lib/sanity';
import { stegaClean } from '@sanity/client/stega';

import DefaultTemplate from '@/layouts/templates/DefaultTemplate.astro';
import FullWidthTemplate from '@/layouts/templates/FullWidthTemplate.astro';
import LandingTemplate from '@/layouts/templates/LandingTemplate.astro';
import SidebarTemplate from '@/layouts/templates/SidebarTemplate.astro';
import TwoColumnTemplate from '@/layouts/templates/TwoColumnTemplate.astro';

const templates = {
  default: DefaultTemplate,
  fullWidth: FullWidthTemplate,
  landing: LandingTemplate,
  sidebar: SidebarTemplate,
  twoColumn: TwoColumnTemplate,
};

// Only used in static builds â€” ignored in server mode
export const prerender = import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED !== "true";

export const getStaticPaths: GetStaticPaths = async () => {
  const pages = await sanityClient.fetch<Array<{ slug: string }>>(ALL_PAGE_SLUGS_QUERY);
  return pages.map((page) => ({
    params: { slug: page.slug },
  }));
};

const { slug } = Astro.params;
const page = await getPage(slug as string);

if (!page) {
  return Astro.redirect('/404');
}

const template = stegaClean(page.template) as keyof typeof templates;
const TemplateComponent = templates[template] ?? DefaultTemplate;
---

<Layout title={page.title ?? undefined} seo={page.seo} hideNav={template === 'landing'}>
  <TemplateComponent>
    <BlockRenderer blocks={page.blocks ?? []} />
  </TemplateComponent>
</Layout>
