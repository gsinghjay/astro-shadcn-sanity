---
import type { GetStaticPaths } from 'astro';
import Layout from '@/layouts/Layout.astro';
import BlockRenderer from '@/components/BlockRenderer.astro';
import SanityPageContent from '@/components/SanityPageContent.astro';
import { sanityClient, ALL_PAGE_SLUGS_QUERY, getPage, getAllSponsors, prefetchPages } from '@/lib/sanity';
import { stegaClean } from '@sanity/client/stega';

import DefaultTemplate from '@/layouts/templates/DefaultTemplate.astro';
import FullWidthTemplate from '@/layouts/templates/FullWidthTemplate.astro';
import LandingTemplate from '@/layouts/templates/LandingTemplate.astro';
import SidebarTemplate from '@/layouts/templates/SidebarTemplate.astro';
import TwoColumnTemplate from '@/layouts/templates/TwoColumnTemplate.astro';

const templates = {
  default: DefaultTemplate,
  fullWidth: FullWidthTemplate,
  landing: LandingTemplate,
  sidebar: SidebarTemplate,
  twoColumn: TwoColumnTemplate,
};

const visualEditingEnabled = import.meta.env.PUBLIC_SANITY_VISUAL_EDITING_ENABLED === 'true';

// getStaticPaths generates static routes for all published pages at build time
export const getStaticPaths: GetStaticPaths = async () => {
  const pages = await sanityClient.fetch<Array<{ slug: string }>>(ALL_PAGE_SLUGS_QUERY);
  // Pre-fetch all pages in parallel batches to populate the cache
  await prefetchPages(pages.map(p => p.slug));
  return pages.map((page) => ({
    params: { slug: page.slug },
  }));
};

const { slug } = Astro.params;

// In static mode: fetch page data and render inline
// In VE mode: skip fetch â€” server island handles its own data fetching
let page = null;
let template: keyof typeof templates = 'default';
let TemplateComponent: typeof DefaultTemplate = DefaultTemplate;
let sponsors: Awaited<ReturnType<typeof getAllSponsors>> = [];

if (!visualEditingEnabled) {
  page = await getPage(slug as string);
  if (!page) {
    return Astro.redirect('/404');
  }
  template = stegaClean(page.template) as keyof typeof templates;
  TemplateComponent = templates[template] ?? DefaultTemplate;
  sponsors = await getAllSponsors();
}
---

<Layout
  title={page?.title ?? undefined}
  seo={page?.seo}
  hideNav={!visualEditingEnabled && template === 'landing'}
>
  {visualEditingEnabled ? (
    <SanityPageContent server:defer slug={slug as string}>
      <div slot="fallback" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
        <div class="animate-pulse space-y-8">
          <div class="h-10 bg-muted rounded w-2/5"></div>
          <div class="h-64 bg-muted rounded"></div>
          <div class="space-y-3">
            <div class="h-4 bg-muted rounded w-3/4"></div>
            <div class="h-4 bg-muted rounded w-1/2"></div>
          </div>
        </div>
      </div>
    </SanityPageContent>
  ) : (
    <TemplateComponent>
      <BlockRenderer blocks={page!.blocks ?? []} sponsors={sponsors} />
    </TemplateComponent>
  )}
</Layout>
