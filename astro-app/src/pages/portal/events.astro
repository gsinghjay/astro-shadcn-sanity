---
export const prerender = false;

import PortalLayout from "@/layouts/PortalLayout.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import PortalCalendar from "@/components/portal/PortalCalendar";
import { loadQuery, ALL_EVENTS_QUERY, SPONSOR_BY_EMAIL_QUERY, getSiteParams } from "@/lib/sanity";
import type { ALL_EVENTS_QUERY_RESULT, SPONSOR_BY_EMAIL_QUERY_RESULT } from "@/sanity.types";

const user = Astro.locals.user;

// Look up sponsor by email to enable "My Projects" nav link
const { result: sponsor } = await loadQuery<SPONSOR_BY_EMAIL_QUERY_RESULT>({
  query: SPONSOR_BY_EMAIL_QUERY,
  params: { email: user?.email ?? '', ...getSiteParams() },
});

// Fetch all events server-side
const { result: events } = await loadQuery<ALL_EVENTS_QUERY_RESULT>({
  query: ALL_EVENTS_QUERY,
  params: getSiteParams(),
});
---

<PortalLayout title="Events" activeNav="/portal/events" sponsorSlug={sponsor?.slug}>
  <div class="flex flex-col gap-6">
    <Breadcrumb
      items={[
        { label: "Portal", href: "/portal/" },
        { label: "Events" },
      ]}
    />

    <div class="flex flex-col gap-2">
      <h1 class="text-2xl font-bold tracking-tight">Events & Schedule</h1>
      <p class="text-muted-foreground">
        View upcoming showcases, workshops, and networking events.
      </p>
    </div>

    <div class="portal-events-calendar min-h-[600px]">
      <PortalCalendar client:load events={JSON.stringify(events ?? [])} />
    </div>
  </div>
</PortalLayout>

<style is:global>
  .portal-events-calendar .sx-react-calendar-wrapper {
    width: 100%;
    height: 600px;
  }
  @media (min-width: 1024px) {
    .portal-events-calendar .sx-react-calendar-wrapper {
      height: 700px;
    }
  }
</style>
