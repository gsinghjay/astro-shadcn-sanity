#!/usr/bin/env node
/**
 * Builds a capture-map.json by pairing each component from the story list
 * with a Figma capture ID.
 *
 * How it works:
 *   1. Reads the story list (component-stories.json) — the components to capture.
 *   2. Reads a text file of capture IDs (one per line) — obtained from Figma.
 *   3. Optionally reads an existing progress file to skip already-captured components.
 *   4. Pairs each uncaptured component with a capture ID.
 *   5. Writes the result to capture-map.json.
 *
 * Usage:
 *   node generate-capture-map.mjs --ids <path> [--stories <path>] [--progress <path>] [--output <path>]
 *
 * Arguments:
 *   --ids        Path to a text file with one capture ID per line (REQUIRED)
 *   --stories    Path to component-stories.json        (default: ./component-stories.json)
 *   --progress   Path to capture-progress.json          (default: ./capture-progress.json)
 *   --output     Path to write capture-map.json         (default: ./capture-map.json)
 *
 * How to get capture IDs:
 *   Each capture ID is generated by calling the Figma MCP tool:
 *     mcp__figma__generate_figma_design(outputMode: "existingFile", fileKey: "<your-file-key>")
 *
 *   This returns a capture ID (UUID). Collect these into a text file, one per line.
 *   You need one ID per component you want to capture.
 *
 * Prerequisites:
 *   - component-stories.json (created by generate-story-list.mjs)
 *   - A text file of capture IDs from Figma
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { resolve } from 'path';

// ---------------------------------------------------------------------------
// Parse CLI arguments
// ---------------------------------------------------------------------------
const args = process.argv.slice(2);

function getArg(name, fallback) {
  const idx = args.indexOf(`--${name}`);
  return idx !== -1 && args[idx + 1] ? args[idx + 1] : fallback;
}

const IDS_FILE = getArg('ids', null);
const STORIES_FILE = resolve(getArg('stories', './component-stories.json'));
const PROGRESS_FILE = resolve(getArg('progress', './capture-progress.json'));
const OUTPUT_FILE = resolve(getArg('output', './capture-map.json'));

// ---------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------
function main() {
  if (!IDS_FILE) {
    console.error('Usage: node generate-capture-map.mjs --ids <capture-ids.txt>');
    console.error('');
    console.error('The --ids file should contain one Figma capture ID (UUID) per line.');
    process.exit(1);
  }

  // Load stories
  if (!existsSync(STORIES_FILE)) {
    console.error(`Story list not found: ${STORIES_FILE}`);
    console.error('Run generate-story-list.mjs first.');
    process.exit(1);
  }
  const stories = JSON.parse(readFileSync(STORIES_FILE, 'utf-8'));
  console.log(`Loaded ${stories.length} components from ${STORIES_FILE}`);

  // Load progress (optional — to skip already-captured components)
  let progress = {};
  try {
    progress = JSON.parse(readFileSync(PROGRESS_FILE, 'utf-8'));
    const doneCount = Object.values(progress).filter((v) => v === 'done').length;
    console.log(`Loaded progress: ${doneCount} already done`);
  } catch {
    console.log('No existing progress file — will map all components');
  }

  // Filter to uncaptured components
  const remaining = stories.filter((s) => progress[s.storyId] !== 'done');
  console.log(`Components to capture: ${remaining.length}`);

  // Load capture IDs
  const idsRaw = readFileSync(resolve(IDS_FILE), 'utf-8');
  const captureIds = idsRaw
    .split('\n')
    .map((line) => line.trim())
    .filter((line) => line.length > 0 && !line.startsWith('#'));
  console.log(`Capture IDs available: ${captureIds.length}`);

  if (captureIds.length < remaining.length) {
    console.error(
      `\nNot enough capture IDs! Need ${remaining.length}, have ${captureIds.length}.`
    );
    console.error('Generate more IDs from Figma and add them to the IDs file.');
    process.exit(1);
  }

  // Build the map
  const captureMap = remaining.map((story, i) => ({
    title: story.title,
    storyId: story.storyId,
    captureId: captureIds[i],
  }));

  writeFileSync(OUTPUT_FILE, JSON.stringify(captureMap, null, 2));
  console.log(`\nWrote ${captureMap.length} entries to ${OUTPUT_FILE}`);

  if (captureIds.length > remaining.length) {
    console.log(
      `Note: ${captureIds.length - remaining.length} unused capture IDs remaining.`
    );
  }
}

main();
